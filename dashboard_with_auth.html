<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Rentabilit√© Clients</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-green-500: rgba(34, 197, 94, 1);
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--color-cream-50); color: var(--color-slate-900); }

        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-700) 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #loginScreen.hidden { display: none; }
        .login-container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { margin: 0 0 10px 0; font-size: 24px; color: var(--color-teal-600); }
        .login-header p { margin: 0; color: var(--color-slate-500); font-size: 13px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 13px; color: var(--color-slate-900); }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 200ms; }
        .form-group input:focus { outline: none; border-color: var(--color-teal-500); box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1); }
        .login-button { width: 100%; padding: 12px; background: var(--color-teal-500); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 200ms; }
        .login-button:hover { background: var(--color-teal-600); }
        .error-message { color: var(--color-red-500); font-size: 13px; margin-top: 10px; display: none; }
        .error-message.show { display: block; }
        .success-message { color: var(--color-green-500); font-size: 13px; margin-top: 10px; display: none; }
        .success-message.show { display: block; }
        .demo-hint { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: var(--color-slate-500); }

        #dashboardScreen, #adminScreen { display: none; }
        #dashboardScreen.active, #adminScreen.active { display: block; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-700) 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0 0 5px 0; font-size: 28px; }
        header p { margin: 0; opacity: 0.95; font-size: 14px; }
        .header-user { text-align: right; font-size: 13px; }
        .role-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; margin-bottom: 8px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-top: 10px; transition: background 200ms; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .admin-panel { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .admin-section { margin-bottom: 40px; }
        .admin-section h3 { margin-top: 0; color: var(--color-teal-600); border-bottom: 2px solid var(--color-gray-200); padding-bottom: 10px; }

        .upload-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .upload-title { font-size: 14px; font-weight: 600; margin-bottom: 15px; color: var(--color-slate-900); }
        .file-input-wrapper { display: flex; gap: 10px; align-items: center; }
        .file-input-wrapper input[type="file"] { flex: 1; padding: 8px 12px; border: 1px dashed var(--color-teal-500); border-radius: 6px; background: rgba(33, 128, 141, 0.05); }

        select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; min-width: 200px; }
        select:focus { outline: none; border-color: var(--color-teal-500); box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1); }

        .btn-upload, .btn-export, .btn-template { padding: 8px 20px; background: var(--color-teal-500); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: background 200ms; }
        .btn-upload:hover, .btn-export:hover, .btn-template:hover { background: var(--color-teal-600); }
        .btn-delete { padding: 6px 12px; background: var(--color-red-500); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-delete:hover { background: #c80030; }

        .clients-list { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
        .clients-list-item { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .clients-list-item:last-child { border-bottom: none; }
        .client-info { flex: 1; }
        .client-email { font-weight: 600; color: var(--color-slate-900); }
        .client-role { font-size: 12px; color: var(--color-slate-500); }

        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 20px; border-radius: 8px; border-left: 4px solid var(--color-teal-500); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .metric-label { font-size: 12px; color: var(--color-slate-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .metric-value { font-size: 24px; font-weight: 600; color: var(--color-teal-600); }

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--color-slate-900); }

        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: var(--color-gray-200); padding: 12px; text-align: left; font-weight: 600; color: var(--color-slate-900); border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .positive { color: var(--color-green-500); font-weight: 600; }
        .grayed { color: var(--color-slate-500); opacity: 0.7; }

        .info-box { background: rgba(33, 128, 141, 0.08); border-left: 3px solid var(--color-teal-500); padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; line-height: 1.6; }

        .filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 13px; font-weight: 500; color: var(--color-slate-900); }
        .btn-reset { padding: 8px 16px; background: var(--color-gray-200); border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: background 200ms; }
        .btn-reset:hover { background: #ddd; }

        .export-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-export { padding: 10px 20px; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .filter-group { width: 100%; }
            header { flex-direction: column; text-align: left; }
            .header-user { text-align: left; margin-top: 15px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>üìä Rentabilit√© Clients</h1>
                <p>Connexion s√©curis√©e</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="ton@email.com" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="login-button">Acc√©der</button>
                <div class="error-message" id="errorMessage"></div>
                <div class="demo-hint">
                    <strong>üîì Admin:</strong><br>
                    admin@example.com / admin123<br><br>
                    <strong>üîì Client:</strong><br>
                    client1@example.com / client123
                </div>
            </form>
        </div>
    </div>

    <!-- ADMIN SCREEN -->
    <div id="adminScreen">
        <div class="container">
            <header>
                <div>
                    <h1>üõ†Ô∏è Panneau Administrateur</h1>
                    <p>Gestion des clients et des donn√©es</p>
                </div>
                <div class="header-user">
                    <div class="role-badge">ADMIN</div>
                    <div>Connect√© : <strong id="adminEmail"></strong></div>
                    <button class="logout-btn" onclick="logout()">D√©connexion</button>
                </div>
            </header>

            <div class="admin-panel">
                <div class="admin-section">
                    <h3>üì§ Importer Clients (authentifiants)</h3>
                    <div class="info-box">
                        <strong>Format CSV:</strong> email,password<br>
                        client1@example.com,password123
                    </div>
                    <div class="upload-section">
                        <div class="upload-title">S√©lectionner un fichier CSV</div>
                        <div class="file-input-wrapper">
                            <input type="file" id="csvClientsFile" accept=".csv">
                            <button class="btn-upload" onclick="uploadClientsCSV()">Importer</button>
                        </div>
                        <div class="success-message" id="successMessage"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>üìä Importer Donn√©es pour un Client</h3>
                    <div class="info-box">
                        <strong>S√©lectionne un client, puis upload son CSV de donn√©es</strong>
                    </div>
                    <div class="upload-section">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">S√©lectionner le client :</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="clientSelect" onchange="updateClientTemplate()">
                                    <option value="">-- S√©lectionne un client --</option>
                                </select>
                                <button class="btn-template" onclick="downloadClientTemplate()">üì• Mod√®le</button>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="upload-title">Charger les donn√©es du client</div>
                            <div class="file-input-wrapper">
                                <input type="file" id="csvClientDataFile" accept=".csv">
                                <button class="btn-upload" onclick="uploadClientData()">Importer</button>
                            </div>
                        </div>
                        <div class="error-message" id="errorClientData"></div>
                        <div class="success-message" id="successClientData"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>üë• Clients Actuels</h3>
                    <div class="clients-list" id="clientsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen">
        <div class="container">
            <header>
                <div>
                    <h1>üìä Analyse Rentabilit√©</h1>
                    <p id="clientName"></p>
                </div>
                <div class="header-user">
                    <div>Connect√© : <strong id="userEmail"></strong></div>
                    <button class="logout-btn" onclick="logout()">D√©connexion</button>
                </div>
            </header>

            <div class="metrics-grid" id="metricsGrid"></div>

            <div class="upload-section">
                <div style="margin-bottom: 15px;">
                    <div class="upload-title">üì• T√©l√©charger Mod√®le CSV</div>
                    <button class="btn-template" onclick="downloadMyTemplate()">üì• Mon Mod√®le</button>
                </div>
                <div>
                    <div class="upload-title">üì§ Importer mes donn√©es</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="csvFile" accept=".csv">
                        <button class="btn-upload" onclick="uploadCSV()">Charger</button>
                    </div>
                    <div class="error-message" id="errorUpload"></div>
                    <div class="success-message" id="successUpload"></div>
                </div>
            </div>

            <div class="export-buttons">
                <button class="btn-export" onclick="exportToCSV()">üì• Exporter CSV</button>
                <button class="btn-export" onclick="exportToJSON()">üì• Exporter JSON</button>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>R√©gion :</label>
                    <select onchange="applyFilters()" id="regionFilter">
                        <option value="">Toutes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Rentabilit√© min (‚Ç¨/h) :</label>
                    <input type="number" id="rentabiliteFilter" placeholder="Ex: 180" onchange="applyFilters()">
                </div>
                <button class="btn-reset" onclick="resetFilters()">üîÑ R√©init</button>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">CA par Client</div>
                    <canvas id="caChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ROI par Client</div>
                    <canvas id="roiChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">CA par R√©gion</div>
                    <canvas id="regionChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Rentabilit√© Horaire</div>
                    <canvas id="rentabiliteChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="chart-title">Tableau D√©taill√©</div>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Heures</th>
                            <th>CA (‚Ç¨)</th>
                            <th>Co√ªt (‚Ç¨)</th>
                            <th>ROI (‚Ç¨)</th>
                            <th>Rentabilit√©/h</th>
                            <th>Marge %</th>
                            <th>R√©gion</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // === AUTHENTIFICATION ===
        let USERS = {
            'admin@example.com': 'admin123',
            'client1@example.com': 'client123'
        };
        const ADMIN_EMAIL = 'admin@example.com';

        // Donn√©es par client
        let CLIENT_DATA = {
            'client1@example.com': {
                clients: ['Projet A', 'Projet B'],
                ca: [4500, 8000],
                roi: [2500, 5000],
                rentabilite: [180, 200],
                heures: [25, 40],
                regions: ['37', '41'],
                marge: [55.56, 62.50],
                cout: [2000, 3000],
                duree: [3, 6]
            }
        };

        function saveUsers() {
            localStorage.setItem('appUsers', JSON.stringify(USERS));
        }

        function saveClientData() {
            localStorage.setItem('clientData', JSON.stringify(CLIENT_DATA));
        }

        function loadUsers() {
            const saved = localStorage.getItem('appUsers');
            if (saved) USERS = JSON.parse(saved);
        }

        function loadClientData() {
            const saved = localStorage.getItem('clientData');
            if (saved) CLIENT_DATA = JSON.parse(saved);
        }

        loadUsers();
        loadClientData();

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorMsg = document.getElementById('errorMessage');

            if (USERS[email] && USERS[email] === password) {
                localStorage.setItem('userEmail', email);
                localStorage.setItem('userRole', email === ADMIN_EMAIL ? 'admin' : 'client');
                document.getElementById('loginScreen').classList.add('hidden');

                if (email === ADMIN_EMAIL) {
                    document.getElementById('adminScreen').classList.add('active');
                    document.getElementById('adminEmail').textContent = email;
                    loadAdminPanel();
                } else {
                    document.getElementById('dashboardScreen').classList.add('active');
                    document.getElementById('userEmail').textContent = email;
                    document.getElementById('clientName').textContent = 'Vos donn√©es';
                    initDashboard(email);
                }
                errorMsg.classList.remove('show');
            } else {
                errorMsg.textContent = '‚ùå Email ou mot de passe incorrect';
                errorMsg.classList.add('show');
            }
        }

        function logout() {
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userRole');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.remove('active');
            document.getElementById('dashboardScreen').classList.remove('active');
            document.getElementById('loginForm').reset();
        }

        window.addEventListener('load', () => {
            const userEmail = localStorage.getItem('userEmail');
            const userRole = localStorage.getItem('userRole');
            if (userEmail && USERS[userEmail]) {
                document.getElementById('loginScreen').classList.add('hidden');
                if (userRole === 'admin') {
                    document.getElementById('adminScreen').classList.add('active');
                    document.getElementById('adminEmail').textContent = userEmail;
                    loadAdminPanel();
                } else {
                    document.getElementById('dashboardScreen').classList.add('active');
                    document.getElementById('userEmail').textContent = userEmail;
                    document.getElementById('clientName').textContent = 'Vos donn√©es';
                    initDashboard(userEmail);
                }
            }
        });

        // === ADMIN PANEL ===
        function loadAdminPanel() {
            updateClientsList();
            updateClientSelect();
        }

        function updateClientsList() {
            const clientsList = document.getElementById('clientsList');
            const clients = Object.entries(USERS).filter(([email]) => email !== ADMIN_EMAIL);

            if (clients.length === 0) {
                clientsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Aucun client.</div>';
                return;
            }

            clientsList.innerHTML = clients.map(([email, password]) => `
                <div class="clients-list-item">
                    <div class="client-info">
                        <div class="client-email">${email}</div>
                        <div class="client-role">${CLIENT_DATA[email] ? CLIENT_DATA[email].clients.length + ' projets' : '0 projet'}</div>
                    </div>
                    <button class="btn-delete" onclick="deleteClient('${email}')">Supprimer</button>
                </div>
            `).join('');
        }

        function updateClientSelect() {
            const select = document.getElementById('clientSelect');
            const clients = Object.keys(USERS).filter(e => e !== ADMIN_EMAIL);
            select.innerHTML = '<option value="">-- S√©lectionne un client --</option>' + 
                clients.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function uploadClientsCSV() {
            const fileInput = document.getElementById('csvClientsFile');
            const file = fileInput.files[0];
            const successMsg = document.getElementById('successMessage');

            if (!file) {
                alert('S√©lectionne un fichier CSV');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    let imported = 0;

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',').map(v => v.trim());
                        const email = values[0];
                        const password = values[1];

                        if (email && password) {
                            USERS[email] = password;
                            if (!CLIENT_DATA[email]) {
                                CLIENT_DATA[email] = {
                                    clients: [],
                                    ca: [],
                                    roi: [],
                                    rentabilite: [],
                                    heures: [],
                                    regions: [],
                                    marge: [],
                                    cout: [],
                                    duree: []
                                };
                            }
                            imported++;
                        }
                    }

                    if (imported > 0) {
                        saveUsers();
                        saveClientData();
                        successMsg.textContent = `‚úÖ ${imported} client(s) import√©(s)!`;
                        successMsg.classList.add('show');
                        setTimeout(() => successMsg.classList.remove('show'), 5000);
                        fileInput.value = '';
                        updateClientsList();
                        updateClientSelect();
                    }
                } catch (error) {
                    alert('Erreur: Format CSV invalide');
                }
            };
            reader.readAsText(file);
        }

        function deleteClient(email) {
            if (confirm(`Supprimer ${email}?`)) {
                delete USERS[email];
                delete CLIENT_DATA[email];
                saveUsers();
                saveClientData();
                updateClientsList();
                updateClientSelect();
            }
        }

        function downloadClientTemplate() {
            const email = document.getElementById('clientSelect').value;
            if (!email) {
                alert('S√©lectionne un client');
                return;
            }

            let csv = 'Client,Nb Heures Prest√©es,CA G√©n√©r√©,Co√ªt Horaire,Dur√©e Mois,R√©gion\n';
            csv += `${email},,,,,\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `modele_${email.split('@')[0]}.csv`;
            a.click();
        }

        function uploadClientData() {
            const fileInput = document.getElementById('csvClientDataFile');
            const email = document.getElementById('clientSelect').value;
            const errorMsg = document.getElementById('errorClientData');
            const successMsg = document.getElementById('successClientData');

            if (!email) {
                errorMsg.textContent = '‚ùå S√©lectionne un client';
                errorMsg.classList.add('show');
                return;
            }

            if (!fileInput.files[0]) {
                errorMsg.textContent = '‚ùå S√©lectionne un fichier CSV';
                errorMsg.classList.add('show');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const newData = {
                        clients: [],
                        ca: [],
                        roi: [],
                        rentabilite: [],
                        heures: [],
                        regions: [],
                        marge: [],
                        cout: [],
                        duree: []
                    };

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',').map(v => v.trim());

                        const clientName = values[0];
                        const heures = parseInt(values[1]);
                        const ca = parseInt(values[2]);
                        const coutHoraire = parseInt(values[3]);
                        const duree = parseInt(values[4]);
                        const region = values[5];

                        if (!clientName || clientName !== email) {
                            errorMsg.textContent = `‚ùå Le CSV doit avoir "${email}" comme client`;
                            errorMsg.classList.add('show');
                            return;
                        }

                        const cout = heures * coutHoraire;
                        const roi = ca - cout;
                        const rentabilite = ca / heures;
                        const marge = ((roi / ca) * 100).toFixed(2);

                        newData.clients.push(clientName);
                        newData.heures.push(heures);
                        newData.ca.push(ca);
                        newData.cout.push(cout);
                        newData.roi.push(roi);
                        newData.rentabilite.push(rentabilite);
                        newData.marge.push(parseFloat(marge));
                        newData.duree.push(duree);
                        newData.regions.push(region);
                    }

                    if (newData.clients.length > 0) {
                        CLIENT_DATA[email] = newData;
                        saveClientData();
                        successMsg.textContent = `‚úÖ ${newData.clients.length} ligne(s) import√©e(s) pour ${email}`;
                        successMsg.classList.add('show');
                        errorMsg.classList.remove('show');
                        setTimeout(() => successMsg.classList.remove('show'), 5000);
                        fileInput.value = '';
                    }
                } catch (error) {
                    errorMsg.textContent = '‚ùå Erreur: Format CSV invalide';
                    errorMsg.classList.add('show');
                }
            };
            reader.readAsText(file);
        }

        function updateClientTemplate() {
            downloadClientTemplate();
        }

        // === DASHBOARD ===
        let filteredData = {};
        let charts = {};
        let currentUserEmail = '';

        function initDashboard(email) {
            currentUserEmail = email;

            // Initialiser les donn√©es si vides
            if (!CLIENT_DATA[email]) {
                CLIENT_DATA[email] = {
                    clients: ['Exemple Projet'],
                    ca: [5000],
                    roi: [2500],
                    rentabilite: [200],
                    heures: [25],
                    regions: ['37'],
                    marge: [50],
                    cout: [2500],
                    duree: [3]
                };
            }

            filteredData = { ...CLIENT_DATA[email] };

            // Populate region filter
            const regionFilter = document.getElementById('regionFilter');
            const uniqueRegions = [...new Set(CLIENT_DATA[email].regions)];
            regionFilter.innerHTML = '<option value="">Toutes</option>' + 
                uniqueRegions.map(r => `<option value="${r}">R√©gion ${r}</option>`).join('');

            updateMetrics();
            updateCharts();
            updateTable();
        }

        function updateMetrics() {
            const caTotal = filteredData.ca.reduce((a, b) => a + b, 0);
            const roiTotal = filteredData.roi.reduce((a, b) => a + b, 0);
            const roiMoyen = filteredData.clients.length > 0 ? (roiTotal / filteredData.clients.length).toFixed(0) : 0;
            const rentabiliteAvg = filteredData.clients.length > 0 ? (filteredData.rentabilite.reduce((a, b) => a + b, 0) / filteredData.clients.length).toFixed(2) : 0;

            document.getElementById('metricsGrid').innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">CA Total</div>
                    <div class="metric-value">‚Ç¨${caTotal.toLocaleString('fr-FR')}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROI Global</div>
                    <div class="metric-value positive">‚Ç¨${roiTotal.toLocaleString('fr-FR')}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROI Moyen</div>
                    <div class="metric-value">‚Ç¨${roiMoyen}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Rentabilit√© Moyenne</div>
                    <div class="metric-value">‚Ç¨${rentabiliteAvg}/h</div>
                </div>
            `;
        }

        function updateCharts() {
            if (filteredData.clients.length === 0) return;

            const colors = ['#2180A0', '#32B8C6', '#A84F2F', '#FF5459'];

            const caCtx = document.getElementById('caChart').getContext('2d');
            if (charts.ca) charts.ca.destroy();
            charts.ca = new Chart(caCtx, {
                type: 'bar',
                data: {
                    labels: filteredData.clients,
                    datasets: [{
                        label: 'CA (‚Ç¨)',
                        data: filteredData.ca,
                        backgroundColor: colors.slice(0, filteredData.clients.length),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const roiCtx = document.getElementById('roiChart').getContext('2d');
            if (charts.roi) charts.roi.destroy();
            charts.roi = new Chart(roiCtx, {
                type: 'bar',
                data: {
                    labels: filteredData.clients,
                    datasets: [{
                        label: 'ROI (‚Ç¨)',
                        data: filteredData.roi,
                        backgroundColor: colors.slice(0, filteredData.clients.length),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const regionData = {};
            filteredData.clients.forEach((client, i) => {
                const region = filteredData.regions[i];
                regionData[region] = (regionData[region] || 0) + filteredData.ca[i];
            });

            const regionCtx = document.getElementById('regionChart').getContext('2d');
            if (charts.region) charts.region.destroy();
            charts.region = new Chart(regionCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(regionData),
                    datasets: [{
                        data: Object.values(regionData),
                        backgroundColor: ['#2180A0', '#32B8C6', '#A84F2F']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            const rentCtx = document.getElementById('rentabiliteChart').getContext('2d');
            if (charts.rent) charts.rent.destroy();
            charts.rent = new Chart(rentCtx, {
                type: 'line',
                data: {
                    labels: filteredData.clients,
                    datasets: [{
                        label: 'Rentabilit√©/h (‚Ç¨)',
                        data: filteredData.rentabilite,
                        borderColor: '#2180A0',
                        backgroundColor: 'rgba(33, 128, 141, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: true } } }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filteredData.clients.map((client, i) => `
                <tr>
                    <td class="grayed"><strong>${client}</strong></td>
                    <td>${filteredData.heures[i]}</td>
                    <td>‚Ç¨${filteredData.ca[i].toLocaleString('fr-FR')}</td>
                    <td>‚Ç¨${filteredData.cout[i].toLocaleString('fr-FR')}</td>
                    <td class="positive">‚Ç¨${filteredData.roi[i].toLocaleString('fr-FR')}</td>
                    <td>‚Ç¨${filteredData.rentabilite[i].toFixed(2)}/h</td>
                    <td>${filteredData.marge[i]}%</td>
                    <td>R√©gion ${filteredData.regions[i]}</td>
                </tr>
            `).join('');
        }

        function applyFilters() {
            const region = document.getElementById('regionFilter').value;
            const rentabiliteMin = parseFloat(document.getElementById('rentabiliteFilter').value) || 0;

            filteredData = {
                clients: [],
                ca: [],
                roi: [],
                rentabilite: [],
                heures: [],
                regions: [],
                marge: [],
                cout: [],
                duree: []
            };

            CLIENT_DATA[currentUserEmail].clients.forEach((client, i) => {
                if ((!region || CLIENT_DATA[currentUserEmail].regions[i] === region) &&
                    CLIENT_DATA[currentUserEmail].rentabilite[i] >= rentabiliteMin) {
                    filteredData.clients.push(client);
                    filteredData.ca.push(CLIENT_DATA[currentUserEmail].ca[i]);
                    filteredData.roi.push(CLIENT_DATA[currentUserEmail].roi[i]);
                    filteredData.rentabilite.push(CLIENT_DATA[currentUserEmail].rentabilite[i]);
                    filteredData.heures.push(CLIENT_DATA[currentUserEmail].heures[i]);
                    filteredData.regions.push(CLIENT_DATA[currentUserEmail].regions[i]);
                    filteredData.marge.push(CLIENT_DATA[currentUserEmail].marge[i]);
                    filteredData.cout.push(CLIENT_DATA[currentUserEmail].cout[i]);
                    filteredData.duree.push(CLIENT_DATA[currentUserEmail].duree[i]);
                }
            });

            updateMetrics();
            updateCharts();
            updateTable();
        }

        function resetFilters() {
            document.getElementById('regionFilter').value = '';
            document.getElementById('rentabiliteFilter').value = '';
            filteredData = { ...CLIENT_DATA[currentUserEmail] };
            updateMetrics();
            updateCharts();
            updateTable();
        }

        function downloadMyTemplate() {
            let csv = 'Client,Nb Heures Prest√©es,CA G√©n√©r√©,Co√ªt Horaire,Dur√©e Mois,R√©gion\n';
            csv += `${currentUserEmail},,,,,\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `modele_mesdata.csv`;
            a.click();
        }

        function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            const errorMsg = document.getElementById('errorUpload');
            const successMsg = document.getElementById('successUpload');

            if (!file) {
                errorMsg.textContent = '‚ùå S√©lectionne un fichier CSV';
                errorMsg.classList.add('show');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const newData = {
                        clients: [],
                        ca: [],
                        roi: [],
                        rentabilite: [],
                        heures: [],
                        regions: [],
                        marge: [],
                        cout: [],
                        duree: []
                    };

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',').map(v => v.trim());

                        const clientName = values[0];
                        const heures = parseInt(values[1]);
                        const ca = parseInt(values[2]);
                        const coutHoraire = parseInt(values[3]);
                        const duree = parseInt(values[4]);
                        const region = values[5];

                        if (clientName !== currentUserEmail) {
                            errorMsg.textContent = `‚ùå Erreur: Le CSV doit avoir "${currentUserEmail}" comme client`;
                            errorMsg.classList.add('show');
                            return;
                        }

                        const cout = heures * coutHoraire;
                        const roi = ca - cout;
                        const rentabilite = ca / heures;
                        const marge = ((roi / ca) * 100).toFixed(2);

                        newData.clients.push(clientName);
                        newData.heures.push(heures);
                        newData.ca.push(ca);
                        newData.cout.push(cout);
                        newData.roi.push(roi);
                        newData.rentabilite.push(rentabilite);
                        newData.marge.push(parseFloat(marge));
                        newData.duree.push(duree);
                        newData.regions.push(region);
                    }

                    if (newData.clients.length > 0) {
                        CLIENT_DATA[currentUserEmail] = newData;
                        saveClientData();
                        filteredData = { ...newData };
                        successMsg.textContent = `‚úÖ ${newData.clients.length} ligne(s) import√©e(s)!`;
                        successMsg.classList.add('show');
                        errorMsg.classList.remove('show');
                        setTimeout(() => successMsg.classList.remove('show'), 5000);
                        fileInput.value = '';
                        updateMetrics();
                        updateCharts();
                        updateTable();
                    }
                } catch (error) {
                    errorMsg.textContent = '‚ùå Erreur: Format CSV invalide';
                    errorMsg.classList.add('show');
                }
            };
            reader.readAsText(file);
        }

        function exportToCSV() {
            const headers = ['Client', 'Heures', 'CA', 'Co√ªt', 'ROI', 'Rentabilit√©/h', 'Marge %', 'R√©gion'];
            const rows = filteredData.clients.map((client, i) => [
                client,
                filteredData.heures[i],
                filteredData.ca[i],
                filteredData.cout[i],
                filteredData.roi[i],
                filteredData.rentabilite[i],
                filteredData.marge[i],
                filteredData.regions[i]
            ]);

            let csv = headers.join(';') + '\n';
            rows.forEach(row => csv += row.join(';') + '\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rentabilite_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function exportToJSON() {
            const data = {
                date: new Date().toISOString(),
                user: currentUserEmail,
                resume: {
                    caTotal: filteredData.ca.reduce((a, b) => a + b, 0),
                    roiTotal: filteredData.roi.reduce((a, b) => a + b, 0)
                },
                donnees: filteredData
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rentabilite_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
    </script>
</body>
</html>
