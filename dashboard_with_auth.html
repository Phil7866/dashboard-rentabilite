<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Rentabilit√© - PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-green-500: rgba(34, 197, 94, 1);
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--color-cream-50); color: var(--color-slate-900); }

        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-700) 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #loginScreen.hidden { display: none; }
        .login-container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { margin: 0 0 10px 0; font-size: 24px; color: var(--color-teal-600); }
        .login-header p { margin: 0; color: var(--color-slate-500); font-size: 13px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--color-teal-500); box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1); }
        .login-button { width: 100%; padding: 12px; background: var(--color-teal-500); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .login-button:hover { background: var(--color-teal-600); }
        .error-message { color: var(--color-red-500); font-size: 13px; margin-top: 10px; display: none; }
        .error-message.show { display: block; }
        .success-message { color: var(--color-green-500); font-size: 13px; margin-top: 10px; display: none; }
        .success-message.show { display: block; }
        .demo-hint { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: var(--color-slate-500); }

        #dashboardScreen, #adminScreen { display: none; }
        #dashboardScreen.active, #adminScreen.active { display: block; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-700) 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0 0 5px 0; font-size: 28px; }
        header p { margin: 0; opacity: 0.95; font-size: 14px; }
        .header-user { text-align: right; font-size: 13px; }
        .role-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; margin-bottom: 8px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-top: 10px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .admin-panel { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .admin-section { margin-bottom: 40px; }
        .admin-section h3 { margin-top: 0; color: var(--color-teal-600); border-bottom: 2px solid var(--color-gray-200); padding-bottom: 10px; }

        .upload-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .upload-title { font-size: 14px; font-weight: 600; margin-bottom: 15px; color: var(--color-slate-900); }
        .file-input-wrapper { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .file-input-wrapper input[type="file"] { flex: 1; padding: 8px 12px; border: 1px dashed var(--color-teal-500); border-radius: 6px; background: rgba(33, 128, 141, 0.05); min-width: 200px; }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }

        .btn-upload, .btn-export, .btn-template { padding: 8px 20px; background: var(--color-teal-500); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-upload:hover, .btn-export:hover, .btn-template:hover { background: var(--color-teal-600); }
        .btn-delete { padding: 6px 12px; background: var(--color-red-500); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-delete:hover { background: #c80030; }

        .clients-list { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
        .clients-list-item { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .clients-list-item:last-child { border-bottom: none; }
        .client-info { flex: 1; }
        .client-email { font-weight: 600; color: var(--color-slate-900); }
        .client-role { font-size: 12px; color: var(--color-slate-500); }

        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 20px; border-radius: 8px; border-left: 4px solid var(--color-teal-500); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .metric-label { font-size: 12px; color: var(--color-slate-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .metric-value { font-size: 24px; font-weight: 600; color: var(--color-teal-600); }

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--color-slate-900); }

        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: var(--color-gray-200); padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .positive { color: var(--color-green-500); font-weight: 600; }

        .info-box { background: rgba(33, 128, 141, 0.08); border-left: 3px solid var(--color-teal-500); padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; line-height: 1.6; }

        .filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 13px; font-weight: 500; }
        .btn-reset { padding: 8px 16px; background: var(--color-gray-200); border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }

        .export-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-export { padding: 10px 20px; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            header { flex-direction: column; text-align: left; }
            .header-user { text-align: left; margin-top: 15px; }
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>üìä Rentabilit√©</h1>
                <p>Connexion s√©curis√©e</p>
            </div>
            <form id="loginForm" onsubmit="AppAuth.handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="ton@email.com" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="login-button">Acc√©der</button>
                <div class="error-message" id="errorMessage"></div>
                <div class="demo-hint">
                    <strong>üîì Admin:</strong><br>
                    admin@example.com / admin123<br><br>
                    <strong>üîì Client D√©mo:</strong><br>
                    client@example.com / client123
                </div>
            </form>
        </div>
    </div>

    <div id="adminScreen">
        <div class="container">
            <header>
                <div><h1>üõ†Ô∏è Administrateur</h1><p>Gestion des clients</p></div>
                <div class="header-user">
                    <div class="role-badge">ADMIN</div>
                    <div>Connect√© : <strong id="adminEmail"></strong></div>
                    <button class="logout-btn" onclick="AppAuth.logout()">D√©connexion</button>
                </div>
            </header>
            <div class="admin-panel" id="adminPanel"></div>
        </div>
    </div>

    <div id="dashboardScreen">
        <div class="container">
            <header>
                <div><h1>üìä Analyse Rentabilit√©</h1><p id="clientName"></p></div>
                <div class="header-user">
                    <div>Connect√© : <strong id="userEmail"></strong></div>
                    <button class="logout-btn" onclick="AppAuth.logout()">D√©connexion</button>
                </div>
            </header>
            <div id="dashboardContent"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIG & CONSTANTS
        // ============================================================
        const CONFIG = {
            ACTIVITY_TYPES: {
                'consultant': 'Client',
                'agence': 'Projet',
                'formateur': 'Formation',
                'coach': 'Accompagnement',
                'custom': '√âl√©ment'
            },
            CSV_COLUMNS: {
                projectName: 0,
                hours: 1,
                ca: 2,
                costPerHour: 3,
                duration: 4,
                region: 5
            }
        };

        // ============================================================
        // STORAGE MANAGER (localStorage abstraction)
        // ============================================================
        const StorageManager = {
            init() {
                if (!localStorage.getItem('appUsers')) {
                    localStorage.setItem('appUsers', JSON.stringify({
                        'admin@example.com': { password: 'admin123', isAdmin: true },
                        'client@example.com': { password: 'client123', isAdmin: false, activity: 'consultant', label: 'Client' }
                    }));
                }
                if (!localStorage.getItem('clientData')) {
                    localStorage.setItem('clientData', JSON.stringify({
                        'client@example.com': { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] }
                    }));
                }
            },
            getUsers() { return JSON.parse(localStorage.getItem('appUsers')) || {}; },
            setUsers(data) { localStorage.setItem('appUsers', JSON.stringify(data)); },
            getClientData() { return JSON.parse(localStorage.getItem('clientData')) || {}; },
            setClientData(data) { localStorage.setItem('clientData', JSON.stringify(data)); },
            getCurrentUser() { return localStorage.getItem('userEmail'); },
            setCurrentUser(email) { localStorage.setItem('userEmail', email); },
            clearCurrentUser() { localStorage.removeItem('userEmail'); }
        };

        // ============================================================
        // CSV PARSER (Robust parsing avec validation)
        // ============================================================
        const CSVParser = {
            parseProjectData(csvText) {
                const lines = csvText.split('\n').filter(l => l.trim());
                if (lines.length < 2) throw new Error('CSV vide ou invalide');

                const projects = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());

                    // Validation des colonnes
                    if (!values[0] || !values[1]) continue;

                    const project = {
                        name: values[CONFIG.CSV_COLUMNS.projectName],
                        hours: parseInt(values[CONFIG.CSV_COLUMNS.hours]) || 0,
                        ca: parseInt(values[CONFIG.CSV_COLUMNS.ca]) || 0,
                        costPerHour: parseInt(values[CONFIG.CSV_COLUMNS.costPerHour]) || 0,
                        duration: parseInt(values[CONFIG.CSV_COLUMNS.duration]) || 0,
                        region: values[CONFIG.CSV_COLUMNS.region] || 'Non sp√©cifi√©'
                    };

                    // Skip si donn√©es vides
                    if (project.hours === 0 || project.ca === 0) continue;
                    projects.push(project);
                }

                if (projects.length === 0) throw new Error('Aucune donn√©e valide trouv√©e');
                return projects;
            },

            projectsToDashboard(projects) {
                return {
                    projects: projects.map(p => p.name),
                    heures: projects.map(p => p.hours),
                    ca: projects.map(p => p.ca),
                    coutHoraire: projects.map(p => p.costPerHour),
                    duree: projects.map(p => p.duration),
                    regions: projects.map(p => p.region)
                };
            }
        };

        // ============================================================
        // CALCULATIONS (m√©tiers)
        // ============================================================
        const Calculations = {
            calculateProjectMetrics(hours, ca, costPerHour) {
                const cout = hours * costPerHour;
                const roi = ca - cout;
                const rentabilite = hours > 0 ? ca / hours : 0;
                const marge = ca > 0 ? ((roi / ca) * 100).toFixed(2) : 0;
                return { cout, roi, rentabilite, marge };
            },

            calculateDashboard(data) {
                const metrics = [];
                for (let i = 0; i < data.projects.length; i++) {
                    metrics.push(this.calculateProjectMetrics(data.heures[i], data.ca[i], data.coutHoraire[i]));
                }

                const caTotal = data.ca.reduce((a, b) => a + b, 0);
                const roiTotal = metrics.reduce((sum, m) => sum + m.roi, 0);
                const roiMoyen = data.projects.length > 0 ? (roiTotal / data.projects.length).toFixed(0) : 0;
                const rentabiliteAvg = metrics.length > 0 ? (metrics.reduce((sum, m) => sum + m.rentabilite, 0) / metrics.length).toFixed(2) : 0;

                return { metrics, caTotal, roiTotal, roiMoyen, rentabiliteAvg };
            }
        };

        // ============================================================
        // AUTH
        // ============================================================
        const AppAuth = {
            handleLogin(event) {
                event.preventDefault();
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const users = StorageManager.getUsers();

                if (users[email] && users[email].password === password) {
                    StorageManager.setCurrentUser(email);
                    document.getElementById('loginScreen').classList.add('hidden');

                    if (users[email].isAdmin) {
                        document.getElementById('adminScreen').classList.add('active');
                        document.getElementById('adminEmail').textContent = email;
                        AdminUI.render();
                    } else {
                        document.getElementById('dashboardScreen').classList.add('active');
                        document.getElementById('userEmail').textContent = email;
                        DashboardUI.init(email);
                    }
                } else {
                    document.getElementById('errorMessage').textContent = '‚ùå Identifiants incorrects';
                    document.getElementById('errorMessage').classList.add('show');
                }
            },

            logout() {
                StorageManager.clearCurrentUser();
                location.reload();
            }
        };

        // ============================================================
        // ADMIN UI
        // ============================================================
        const AdminUI = {
            render() {
                const panel = document.getElementById('adminPanel');
                const users = StorageManager.getUsers();
                const clientData = StorageManager.getClientData();
                const clientList = Object.entries(users).filter(([e, u]) => !u.isAdmin);

                panel.innerHTML = `
                    <div class="admin-section">
                        <h3>‚ûï Ajouter Client</h3>
                        <div class="upload-section">
                            <div class="form-row">
                                <input type="email" id="newEmail" placeholder="Email">
                                <input type="password" id="newPassword" placeholder="Mot de passe">
                            </div>
                            <div class="form-row">
                                <select id="activityType">
                                    ${Object.entries(CONFIG.ACTIVITY_TYPES).map(([k,v]) => `<option value="${k}">${v}</option>`).join('')}
                                </select>
                            </div>
                            <button class="btn-upload" style="width:100%" onclick="AdminUI.addClient()">Cr√©er</button>
                            <div class="success-message" id="successAddClient"></div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üìä Importer Donn√©es Client</h3>
                        <div class="upload-section">
                            <div class="form-row">
                                <select id="clientSelect" onchange="AdminUI.updateLabel()">
                                    <option value="">-- S√©lectionne un client --</option>
                                    ${clientList.map(([e,u]) => `<option value="${e}">${e}</option>`).join('')}
                                </select>
                                <button class="btn-template" onclick="AdminUI.downloadTemplate()">üì• Mod√®le</button>
                            </div>
                            <div class="file-input-wrapper">
                                <input type="file" id="csvDataFile" accept=".csv">
                                <button class="btn-upload" onclick="AdminUI.uploadClientData()">Importer</button>
                            </div>
                            <div class="success-message" id="successData"></div>
                            <div class="error-message" id="errorData"></div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üë• Clients</h3>
                        <div class="clients-list">
                            ${clientList.length === 0 ? '<div style="padding: 20px; text-align: center; color: #999;">Aucun client</div>' : 
                              clientList.map(([e,u]) => `
                                <div class="clients-list-item">
                                    <div class="client-info">
                                        <div class="client-email">${e}</div>
                                        <div class="client-role">${u.label} ‚Ä¢ ${clientData[e]?.projects.length || 0} projets</div>
                                    </div>
                                    <button class="btn-delete" onclick="AdminUI.deleteClient('${e}')">Supprimer</button>
                                </div>
                              `).join('')}
                        </div>
                    </div>
                `;
            },

            addClient() {
                const email = document.getElementById('newEmail').value.trim();
                const password = document.getElementById('newPassword').value;
                const activity = document.getElementById('activityType').value;
                const label = CONFIG.ACTIVITY_TYPES[activity];

                if (!email || !password) { alert('Email et mot de passe requis'); return; }

                const users = StorageManager.getUsers();
                const data = StorageManager.getClientData();

                users[email] = { password, isAdmin: false, activity, label };
                data[email] = { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] };

                StorageManager.setUsers(users);
                StorageManager.setClientData(data);

                document.getElementById('newEmail').value = '';
                document.getElementById('newPassword').value = '';
                const msg = document.getElementById('successAddClient');
                msg.textContent = `‚úÖ Client cr√©√©`;
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
                this.render();
            },

            deleteClient(email) {
                if (!confirm(`Supprimer ${email}?`)) return;
                const users = StorageManager.getUsers();
                const data = StorageManager.getClientData();
                delete users[email];
                delete data[email];
                StorageManager.setUsers(users);
                StorageManager.setClientData(data);
                this.render();
            },

            updateLabel() {
                const email = document.getElementById('clientSelect').value;
                if (email) {
                    const users = StorageManager.getUsers();
                    document.getElementById('csvDataFile').placeholder = `CSV pour "${users[email].label}"`;
                }
            },

            downloadTemplate() {
                const email = document.getElementById('clientSelect').value;
                if (!email) { alert('S√©lectionne un client'); return; }

                const users = StorageManager.getUsers();
                const label = users[email].label;
                let csv = `${label},Nb Heures,CA,Co√ªt/h,Dur√©e,R√©gion\n`;
                csv += `Exemple,25,5000,80,3,37\n`;

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `modele_${email.split('@')[0]}.csv`;
                link.click();
            },

            uploadClientData() {
                const email = document.getElementById('clientSelect').value;
                const file = document.getElementById('csvDataFile').files[0];
                const errorMsg = document.getElementById('errorData');
                const successMsg = document.getElementById('successData');

                if (!email) { errorMsg.textContent = '‚ùå S√©lectionne un client'; errorMsg.classList.add('show'); return; }
                if (!file) { errorMsg.textContent = '‚ùå S√©lectionne un fichier'; errorMsg.classList.add('show'); return; }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const projects = CSVParser.parseProjectData(e.target.result);
                        const dashboard = CSVParser.projectsToDashboard(projects);

                        const data = StorageManager.getClientData();
                        data[email] = dashboard;
                        StorageManager.setClientData(data);

                        successMsg.textContent = `‚úÖ ${projects.length} projet(s) import√©(s)`;
                        successMsg.classList.add('show');
                        errorMsg.classList.remove('show');
                        document.getElementById('csvDataFile').value = '';

                        setTimeout(() => successMsg.classList.remove('show'), 2000);
                    } catch (error) {
                        errorMsg.textContent = `‚ùå ${error.message}`;
                        errorMsg.classList.add('show');
                    }
                };
                reader.readAsText(file);
            }
        };

        // ============================================================
        // DASHBOARD UI
        // ============================================================
        const DashboardUI = {
            currentEmail: null,
            filteredData: null,
            charts: {},

            init(email) {
                this.currentEmail = email;
                const users = StorageManager.getUsers();
                document.getElementById('clientName').textContent = `Label: "${users[email].label}"`;
                this.refresh();
            },

            refresh() {
                const data = StorageManager.getClientData()[this.currentEmail] || { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] };

                this.filteredData = {
                    projects: [...data.projects],
                    heures: [...data.heures],
                    ca: [...data.ca],
                    coutHoraire: [...data.coutHoraire],
                    duree: [...data.duree],
                    regions: [...data.regions]
                };

                this.render();
            },

            render() {
                const users = StorageManager.getUsers();
                const user = users[this.currentEmail];
                const calc = Calculations.calculateDashboard(this.filteredData);

                document.getElementById('dashboardContent').innerHTML = `
                    <div class="metrics-grid">
                        <div class="metric-card"><div class="metric-label">CA Total</div><div class="metric-value">‚Ç¨${calc.caTotal.toLocaleString('fr-FR')}</div></div>
                        <div class="metric-card"><div class="metric-label">ROI Global</div><div class="metric-value positive">‚Ç¨${calc.roiTotal.toLocaleString('fr-FR')}</div></div>
                        <div class="metric-card"><div class="metric-label">ROI Moyen</div><div class="metric-value">‚Ç¨${calc.roiMoyen}</div></div>
                        <div class="metric-card"><div class="metric-label">Rentabilit√© Moy</div><div class="metric-value">‚Ç¨${calc.rentabiliteAvg}/h</div></div>
                    </div>

                    <div class="upload-section">
                        <div class="upload-title">üì• T√©l√©charger Mod√®le</div>
                        <button class="btn-template" onclick="DashboardUI.downloadTemplate()">üì• CSV</button>
                    </div>

                    <div class="upload-section">
                        <div class="upload-title">üì§ Importer Mes Donn√©es</div>
                        <div class="file-input-wrapper">
                            <input type="file" id="csvFile" accept=".csv">
                            <button class="btn-upload" onclick="DashboardUI.uploadCSV()">Charger</button>
                        </div>
                        <div class="success-message" id="successUpload"></div>
                        <div class="error-message" id="errorUpload"></div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn-export" onclick="DashboardUI.exportCSV()">üì• Export CSV</button>
                        <button class="btn-export" onclick="DashboardUI.exportJSON()">üì• Export JSON</button>
                    </div>

                    <div class="filters">
                        <button class="btn-reset" onclick="DashboardUI.refresh()">üîÑ R√©initialiser</button>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-container"><div class="chart-title">CA par Projet</div><canvas id="caChart"></canvas></div>
                        <div class="chart-container"><div class="chart-title">ROI par Projet</div><canvas id="roiChart"></canvas></div>
                        <div class="chart-container"><div class="chart-title">CA par R√©gion</div><canvas id="regionChart"></canvas></div>
                        <div class="chart-container"><div class="chart-title">Rentabilit√©/h</div><canvas id="rentChart"></canvas></div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead><tr>
                                <th>${user.label}</th>
                                <th>Heures</th>
                                <th>CA (‚Ç¨)</th>
                                <th>Co√ªt (‚Ç¨)</th>
                                <th>ROI (‚Ç¨)</th>
                                <th>Rentabilit√©/h</th>
                                <th>Marge %</th>
                                <th>R√©gion</th>
                            </tr></thead>
                            <tbody>
                                ${this.filteredData.projects.map((p, i) => {
                                    const m = calc.metrics[i];
                                    return `<tr>
                                        <td><strong>${p}</strong></td>
                                        <td>${this.filteredData.heures[i]}</td>
                                        <td>‚Ç¨${this.filteredData.ca[i].toLocaleString('fr-FR')}</td>
                                        <td>‚Ç¨${m.cout.toLocaleString('fr-FR')}</td>
                                        <td class="positive">‚Ç¨${m.roi.toLocaleString('fr-FR')}</td>
                                        <td>‚Ç¨${m.rentabilite.toFixed(2)}/h</td>
                                        <td>${m.marge}%</td>
                                        <td>${this.filteredData.regions[i]}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                this.renderCharts(calc);
            },

            renderCharts(calc) {
                if (this.filteredData.projects.length === 0) return;

                const colors = ['#2180A0', '#32B8C6', '#A84F2F', '#FF5459'];

                // CA Chart
                const caCtx = document.getElementById('caChart').getContext('2d');
                if (this.charts.ca) this.charts.ca.destroy();
                this.charts.ca = new Chart(caCtx, {
                    type: 'bar',
                    data: {
                        labels: this.filteredData.projects,
                        datasets: [{ label: 'CA (‚Ç¨)', data: this.filteredData.ca, backgroundColor: colors, borderRadius: 6 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });

                // ROI Chart
                const roiCtx = document.getElementById('roiChart').getContext('2d');
                if (this.charts.roi) this.charts.roi.destroy();
                this.charts.roi = new Chart(roiCtx, {
                    type: 'bar',
                    data: {
                        labels: this.filteredData.projects,
                        datasets: [{ label: 'ROI (‚Ç¨)', data: calc.metrics.map(m => m.roi), backgroundColor: colors, borderRadius: 6 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });

                // Region Chart
                const regionData = {};
                this.filteredData.projects.forEach((p, i) => {
                    const r = this.filteredData.regions[i] || 'N/A';
                    regionData[r] = (regionData[r] || 0) + this.filteredData.ca[i];
                });
                const regionCtx = document.getElementById('regionChart').getContext('2d');
                if (this.charts.region) this.charts.region.destroy();
                this.charts.region = new Chart(regionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(regionData),
                        datasets: [{ data: Object.values(regionData), backgroundColor: colors }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });

                // Rentability Chart
                const rentCtx = document.getElementById('rentChart').getContext('2d');
                if (this.charts.rent) this.charts.rent.destroy();
                this.charts.rent = new Chart(rentCtx, {
                    type: 'line',
                    data: {
                        labels: this.filteredData.projects,
                        datasets: [{ label: 'Rentabilit√©/h (‚Ç¨)', data: calc.metrics.map(m => m.rentabilite), borderColor: '#2180A0', backgroundColor: 'rgba(33, 128, 141, 0.1)', tension: 0.4, fill: true, pointRadius: 6 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: true } } }
                });
            },

            downloadTemplate() {
                const users = StorageManager.getUsers();
                const label = users[this.currentEmail].label;
                let csv = `${label},Nb Heures,CA,Co√ªt/h,Dur√©e,R√©gion\n`;
                csv += `Exemple,25,5000,80,3,37\n`;

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'modele.csv';
                link.click();
            },

            uploadCSV() {
                const file = document.getElementById('csvFile').files[0];
                const errorMsg = document.getElementById('errorUpload');
                const successMsg = document.getElementById('successUpload');

                if (!file) { errorMsg.textContent = '‚ùå S√©lectionne un fichier'; errorMsg.classList.add('show'); return; }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const projects = CSVParser.parseProjectData(e.target.result);
                        const dashboard = CSVParser.projectsToDashboard(projects);

                        const data = StorageManager.getClientData();
                        data[this.currentEmail] = dashboard;
                        StorageManager.setClientData(data);

                        successMsg.textContent = `‚úÖ ${projects.length} projet(s) import√©(s)`;
                        successMsg.classList.add('show');
                        errorMsg.classList.remove('show');
                        document.getElementById('csvFile').value = '';

                        this.refresh();
                        setTimeout(() => successMsg.classList.remove('show'), 2000);
                    } catch (error) {
                        errorMsg.textContent = `‚ùå ${error.message}`;
                        errorMsg.classList.add('show');
                    }
                };
                reader.readAsText(file);
            },

            exportCSV() {
                const users = StorageManager.getUsers();
                const user = users[this.currentEmail];
                const calc = Calculations.calculateDashboard(this.filteredData);

                let csv = `${user.label},Heures,CA,Co√ªt,ROI,Rentabilit√©/h,Marge %,R√©gion\n`;
                for (let i = 0; i < this.filteredData.projects.length; i++) {
                    const m = calc.metrics[i];
                    csv += `${this.filteredData.projects[i]},${this.filteredData.heures[i]},${this.filteredData.ca[i]},${m.cout},${m.roi},${m.rentabilite.toFixed(2)},${m.marge},${this.filteredData.regions[i]}\n`;
                }

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            },

            exportJSON() {
                const calc = Calculations.calculateDashboard(this.filteredData);
                const json = {
                    date: new Date().toISOString(),
                    user: this.currentEmail,
                    data: this.filteredData.projects.map((p, i) => ({
                        projet: p,
                        heures: this.filteredData.heures[i],
                        ca: this.filteredData.ca[i],
                        cout: calc.metrics[i].cout,
                        roi: calc.metrics[i].roi,
                        rentabilite: calc.metrics[i].rentabilite,
                        marge: calc.metrics[i].marge,
                        region: this.filteredData.regions[i]
                    }))
                };

                const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `export_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }
        };

        // ============================================================
        // INIT
        // ============================================================
        window.addEventListener('load', () => {
            StorageManager.init();
            const userEmail = StorageManager.getCurrentUser();
            if (userEmail) {
                const users = StorageManager.getUsers();
                document.getElementById('loginScreen').classList.add('hidden');

                if (users[userEmail].isAdmin) {
                    document.getElementById('adminScreen').classList.add('active');
                    document.getElementById('adminEmail').textContent = userEmail;
                    AdminUI.render();
                } else {
                    document.getElementById('dashboardScreen').classList.add('active');
                    document.getElementById('userEmail').textContent = userEmail;
                    DashboardUI.init(userEmail);
                }
            }
        });
    </script>
</body>
</html>
