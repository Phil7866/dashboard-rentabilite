<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Rentabilit√©</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-green-500: rgba(34, 197, 94, 1);
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--color-cream-50); color: var(--color-slate-900); }

        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-700) 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #loginScreen.hidden { display: none; }
        .login-container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { margin: 0 0 10px 0; font-size: 24px; color: var(--color-teal-600); }
        .login-header p { margin: 0; color: var(--color-slate-500); font-size: 13px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--color-teal-500); box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1); }
        .login-button { width: 100%; padding: 12px; background: var(--color-teal-500); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .login-button:hover { background: var(--color-teal-600); }
        .error-message { color: var(--color-red-500); font-size: 13px; margin-top: 10px; display: none; }
        .error-message.show { display: block; }
        .success-message { color: var(--color-green-500); font-size: 13px; margin-top: 10px; display: none; }
        .success-message.show { display: block; }
        .demo-hint { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: var(--color-slate-500); }

        #dashboardScreen, #adminScreen { display: none; }
        #dashboardScreen.active, #adminScreen.active { display: block; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-700) 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0 0 5px 0; font-size: 28px; }
        header p { margin: 0; opacity: 0.95; font-size: 14px; }
        .header-user { text-align: right; font-size: 13px; }
        .role-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; margin-bottom: 8px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-top: 10px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .admin-panel { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .admin-section { margin-bottom: 40px; }
        .admin-section h3 { margin-top: 0; color: var(--color-teal-600); border-bottom: 2px solid var(--color-gray-200); padding-bottom: 10px; }

        .upload-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .upload-title { font-size: 14px; font-weight: 600; margin-bottom: 15px; color: var(--color-slate-900); }
        .file-input-wrapper { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .file-input-wrapper input[type="file"] { flex: 1; padding: 8px 12px; border: 1px dashed var(--color-teal-500); border-radius: 6px; background: rgba(33, 128, 141, 0.05); min-width: 200px; }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }

        .btn-upload, .btn-export, .btn-template { padding: 8px 20px; background: var(--color-teal-500); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-upload:hover, .btn-export:hover, .btn-template:hover { background: var(--color-teal-600); }
        .btn-delete { padding: 6px 12px; background: var(--color-red-500); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-delete:hover { background: #c80030; }

        .clients-list { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
        .clients-list-item { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .clients-list-item:last-child { border-bottom: none; }
        .client-info { flex: 1; }
        .client-email { font-weight: 600; color: var(--color-slate-900); }
        .client-role { font-size: 12px; color: var(--color-slate-500); }

        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 20px; border-radius: 8px; border-left: 4px solid var(--color-teal-500); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .metric-label { font-size: 12px; color: var(--color-slate-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .metric-value { font-size: 24px; font-weight: 600; color: var(--color-teal-600); }

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--color-slate-900); }

        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: var(--color-gray-200); padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .positive { color: var(--color-green-500); font-weight: 600; }

        .info-box { background: rgba(33, 128, 141, 0.08); border-left: 3px solid var(--color-teal-500); padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; line-height: 1.6; }

        .filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 13px; font-weight: 500; }
        .btn-reset { padding: 8px 16px; background: var(--color-gray-200); border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }

        .export-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-export { padding: 10px 20px; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            header { flex-direction: column; text-align: left; }
            .header-user { text-align: left; margin-top: 15px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>üìä Rentabilit√©</h1>
                <p>Connexion s√©curis√©e</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="ton@email.com" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="login-button">Acc√©der</button>
                <div class="error-message" id="errorMessage"></div>
                <div class="demo-hint">
                    <strong>üîì Admin:</strong><br>
                    admin@example.com / admin123<br><br>
                    <strong>üîì Client D√©mo:</strong><br>
                    client@example.com / client123
                </div>
            </form>
        </div>
    </div>

    <!-- ADMIN SCREEN -->
    <div id="adminScreen">
        <div class="container">
            <header>
                <div>
                    <h1>üõ†Ô∏è Administrateur</h1>
                    <p>Gestion des clients</p>
                </div>
                <div class="header-user">
                    <div class="role-badge">ADMIN</div>
                    <div>Connect√© : <strong id="adminEmail"></strong></div>
                    <button class="logout-btn" onclick="logout()">D√©connexion</button>
                </div>
            </header>

            <div class="admin-panel">
                <div class="admin-section">
                    <h3>üì§ Importer Clients (CSV)</h3>
                    <div class="info-box">
                        <strong>Format CSV:</strong> email,password,activit√©<br>
                        client1@example.com,password123,consultant<br>
                        client2@example.com,password456,formateur
                    </div>
                    <div class="upload-section">
                        <div class="file-input-wrapper">
                            <input type="file" id="csvClientsFile" accept=".csv">
                            <button class="btn-upload" onclick="uploadClientsCSV()">Importer</button>
                        </div>
                        <div class="success-message" id="successImportClients"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>‚ûï Ajouter un Client</h3>
                    <div class="upload-section">
                        <div class="form-row">
                            <input type="email" id="newEmail" placeholder="Email du client" required>
                            <input type="password" id="newPassword" placeholder="Mot de passe" required>
                        </div>
                        <div class="form-row">
                            <select id="activityType">
                                <option value="consultant">Consultant</option>
                                <option value="agence">Agence Web</option>
                                <option value="formateur">Formateur</option>
                                <option value="coach">Coach</option>
                                <option value="custom">Personnalis√©</option>
                            </select>
                            <input type="text" id="customLabel" placeholder="Label (ex: Projet, Client, Formation)" style="display:none;">
                        </div>
                        <button class="btn-upload" onclick="addClient()" style="width: 100%;">Cr√©er Client</button>
                        <div class="success-message" id="successAddClient"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>üìä Importer Donn√©es pour un Client</h3>
                    <div class="info-box">
                        CSV: [Nom du Projet],Heures,CA,Co√ªt/h,Dur√©e,R√©gion
                    </div>
                    <div class="upload-section">
                        <div class="form-row">
                            <select id="clientSelect" onchange="updateClientLabel()">
                                <option value="">-- S√©lectionne un client --</option>
                            </select>
                            <button class="btn-template" onclick="downloadTemplate()">üì• Mod√®le</button>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" id="csvDataFile" accept=".csv">
                            <button class="btn-upload" onclick="uploadClientData()">Importer</button>
                        </div>
                        <div class="error-message" id="errorData"></div>
                        <div class="success-message" id="successData"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>üë• Clients Actuels</h3>
                    <div class="clients-list" id="clientsList"></div>
                </div>

                <div class="admin-section">
                    <h3>üì• Exporter Clients</h3>
                    <button class="btn-export" onclick="downloadClientsList()" style="width: 100%; padding: 12px;">üì• T√©l√©charger Liste Clients (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen">
        <div class="container">
            <header>
                <div>
                    <h1>üìä Analyse Rentabilit√©</h1>
                    <p id="clientName"></p>
                </div>
                <div class="header-user">
                    <div>Connect√© : <strong id="userEmail"></strong></div>
                    <button class="logout-btn" onclick="logout()">D√©connexion</button>
                </div>
            </header>

            <div class="metrics-grid" id="metricsGrid"></div>

            <div class="upload-section">
                <div style="margin-bottom: 15px;">
                    <div class="upload-title">üì• T√©l√©charger Mod√®le CSV</div>
                    <button class="btn-template" onclick="downloadMyTemplate()">üì• T√©l√©charger</button>
                </div>
                <div>
                    <div class="upload-title">üì§ Importer mes donn√©es</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="csvFile" accept=".csv">
                        <button class="btn-upload" onclick="uploadCSV()">Charger</button>
                    </div>
                    <div class="error-message" id="errorUpload"></div>
                    <div class="success-message" id="successUpload"></div>
                </div>
            </div>

            <div class="export-buttons">
                <button class="btn-export" onclick="exportToCSV()">üì• Exporter CSV</button>
                <button class="btn-export" onclick="exportToJSON()">üì• Exporter JSON</button>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>R√©gion :</label>
                    <select id="regionFilter" onchange="applyFilters()">
                        <option value="">Toutes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Rentabilit√© min (‚Ç¨/h) :</label>
                    <input type="number" id="rentabiliteFilter" placeholder="Ex: 180" onchange="applyFilters()">
                </div>
                <button class="btn-reset" onclick="resetFilters()">üîÑ R√©init</button>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">CA par Projet</div>
                    <canvas id="caChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ROI par Projet</div>
                    <canvas id="roiChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">CA par R√©gion</div>
                    <canvas id="regionChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Rentabilit√© Horaire</div>
                    <canvas id="rentabiliteChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th id="colName">Projet</th>
                            <th>Heures</th>
                            <th>CA (‚Ç¨)</th>
                            <th>Co√ªt (‚Ç¨)</th>
                            <th>ROI (‚Ç¨)</th>
                            <th>Rentabilit√©/h</th>
                            <th>Marge %</th>
                            <th>R√©gion</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // === SETUP ===
        const ACTIVITY_TYPES = {
            'consultant': 'Client',
            'agence': 'Projet',
            'formateur': 'Formation',
            'coach': 'Accompagnement',
            'custom': '√âl√©ment'
        };

        let USERS = {
            'admin@example.com': { password: 'admin123', isAdmin: true },
            'client@example.com': { password: 'client123', isAdmin: false, activity: 'consultant', label: 'Client' }
        };

        let CLIENT_DATA = {
            'client@example.com': {
                projects: ['Projet Demo'],
                heures: [25],
                ca: [5000],
                coutHoraire: [80],
                duree: [3],
                regions: ['37']
            }
        };

        function saveData() {
            localStorage.setItem('appUsers', JSON.stringify(USERS));
            localStorage.setItem('clientData', JSON.stringify(CLIENT_DATA));
        }

        function loadData() {
            const u = localStorage.getItem('appUsers');
            const c = localStorage.getItem('clientData');
            if (u) USERS = JSON.parse(u);
            if (c) CLIENT_DATA = JSON.parse(c);
        }

        loadData();

        // === LOGIN ===
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorMsg = document.getElementById('errorMessage');

            if (USERS[email] && USERS[email].password === password) {
                localStorage.setItem('userEmail', email);
                document.getElementById('loginScreen').classList.add('hidden');

                if (USERS[email].isAdmin) {
                    document.getElementById('adminScreen').classList.add('active');
                    document.getElementById('adminEmail').textContent = email;
                    loadAdminPanel();
                } else {
                    document.getElementById('dashboardScreen').classList.add('active');
                    document.getElementById('userEmail').textContent = email;
                    initDashboard(email);
                }
                errorMsg.classList.remove('show');
            } else {
                errorMsg.textContent = '‚ùå Identifiants incorrects';
                errorMsg.classList.add('show');
            }
        }

        function logout() {
            localStorage.removeItem('userEmail');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.remove('active');
            document.getElementById('dashboardScreen').classList.remove('active');
            document.getElementById('loginForm').reset();
        }

        window.addEventListener('load', () => {
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail && USERS[userEmail]) {
                document.getElementById('loginScreen').classList.add('hidden');
                if (USERS[userEmail].isAdmin) {
                    document.getElementById('adminScreen').classList.add('active');
                    document.getElementById('adminEmail').textContent = userEmail;
                    loadAdminPanel();
                } else {
                    document.getElementById('dashboardScreen').classList.add('active');
                    document.getElementById('userEmail').textContent = userEmail;
                    initDashboard(userEmail);
                }
            }
        });

        // === ADMIN ===
        function loadAdminPanel() {
            updateClientsList();
            updateClientSelect();
            updateActivitySelect();
        }

        function updateActivitySelect() {
            const select = document.getElementById('activityType');
            const customLabel = document.getElementById('customLabel');
            select.onchange = () => {
                customLabel.style.display = select.value === 'custom' ? 'block' : 'none';
            };
        }

        function uploadClientsCSV() {
            const file = document.getElementById('csvClientsFile').files[0];
            const successMsg = document.getElementById('successImportClients');

            if (!file) {
                alert('S√©lectionne un fichier CSV');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    let imported = 0;

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',').map(v => v.trim());
                        const email = values[0];
                        const password = values[1];
                        const activity = values[2] || 'consultant';
                        const label = ACTIVITY_TYPES[activity] || activity;

                        if (email && password) {
                            USERS[email] = { password, isAdmin: false, activity, label };
                            CLIENT_DATA[email] = { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] };
                            imported++;
                        }
                    }

                    if (imported > 0) {
                        saveData();
                        successMsg.textContent = `‚úÖ ${imported} client(s) import√©(s)`;
                        successMsg.classList.add('show');
                        setTimeout(() => successMsg.classList.remove('show'), 3000);
                        document.getElementById('csvClientsFile').value = '';
                        updateClientsList();
                        updateClientSelect();
                    }
                } catch (error) {
                    alert('Erreur: Format CSV invalide');
                }
            };
            reader.readAsText(file);
        }

        function addClient() {
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const activity = document.getElementById('activityType').value;
            const label = activity === 'custom' ? document.getElementById('customLabel').value : ACTIVITY_TYPES[activity];

            if (!email || !password || !label) {
                alert('Remplis tous les champs');
                return;
            }

            USERS[email] = { password, isAdmin: false, activity, label };
            CLIENT_DATA[email] = { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] };
            saveData();

            document.getElementById('newEmail').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('customLabel').value = '';
            document.getElementById('activityType').value = 'consultant';

            const msg = document.getElementById('successAddClient');
            msg.textContent = `‚úÖ ${email} cr√©√© avec le label "${label}"`;
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 3000);

            updateClientsList();
            updateClientSelect();
        }

        function updateClientsList() {
            const list = document.getElementById('clientsList');
            const clients = Object.entries(USERS).filter(([e, u]) => !u.isAdmin);

            if (clients.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Aucun client.</div>';
                return;
            }

            list.innerHTML = clients.map(([email, user]) => `
                <div class="clients-list-item">
                    <div class="client-info">
                        <div class="client-email">${email}</div>
                        <div class="client-role">Label: "${user.label}" ‚Ä¢ ${CLIENT_DATA[email]?.projects.length || 0} projets</div>
                    </div>
                    <button class="btn-delete" onclick="deleteClient('${email}')">Supprimer</button>
                </div>
            `).join('');
        }

        function updateClientSelect() {
            const select = document.getElementById('clientSelect');
            const clients = Object.entries(USERS).filter(([e, u]) => !u.isAdmin);
            select.innerHTML = '<option value="">-- S√©lectionne un client --</option>' + 
                clients.map(([e, u]) => `<option value="${e}">${e} (${u.label})</option>`).join('');
        }

        function updateClientLabel() {
            const email = document.getElementById('clientSelect').value;
            if (email && USERS[email]) {
                document.getElementById('csvDataFile').placeholder = `CSV avec label "${USERS[email].label}"`;
            }
        }

        function deleteClient(email) {
            if (confirm(`Supprimer ${email}?`)) {
                delete USERS[email];
                delete CLIENT_DATA[email];
                saveData();
                updateClientsList();
                updateClientSelect();
            }
        }

        function downloadTemplate() {
            const email = document.getElementById('clientSelect').value;
            if (!email) { alert('S√©lectionne un client'); return; }

            const label = USERS[email].label;
            let csv = `${label},Nb Heures,CA G√©n√©r√©,Co√ªt Horaire,Dur√©e Mois,R√©gion\n`;
            csv += `${label} 1,,,,,\n`;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `modele_${email.split('@')[0]}.csv`;
            link.click();
        }

        function uploadClientData() {
            const email = document.getElementById('clientSelect').value;
            const file = document.getElementById('csvDataFile').files[0];
            const errorMsg = document.getElementById('errorData');
            const successMsg = document.getElementById('successData');

            if (!email) { errorMsg.textContent = '‚ùå S√©lectionne un client'; errorMsg.classList.add('show'); return; }
            if (!file) { errorMsg.textContent = '‚ùå S√©lectionne un fichier'; errorMsg.classList.add('show'); return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const newData = { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] };

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',').map(v => v.trim());

                        newData.projects.push(values[0]);
                        newData.heures.push(parseInt(values[1]));
                        newData.ca.push(parseInt(values[2]));
                        newData.coutHoraire.push(parseInt(values[3]));
                        newData.duree.push(parseInt(values[4]));
                        newData.regions.push(values[5]);
                    }

                    if (newData.projects.length > 0) {
                        CLIENT_DATA[email] = newData;
                        saveData();
                        successMsg.textContent = `‚úÖ ${newData.projects.length} ligne(s) import√©e(s)`;
                        successMsg.classList.add('show');
                        errorMsg.classList.remove('show');
                        setTimeout(() => successMsg.classList.remove('show'), 3000);
                        document.getElementById('csvDataFile').value = '';
                    }
                } catch (error) {
                    errorMsg.textContent = '‚ùå Erreur CSV';
                    errorMsg.classList.add('show');
                }
            };
            reader.readAsText(file);
        }

        function downloadClientsList() {
            const clients = Object.entries(USERS).filter(([e, u]) => !u.isAdmin);
            let csv = 'email,password,activit√©\n';
            clients.forEach(([email, user]) => {
                csv += `${email},${user.password},${user.activity}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `clients_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // === DASHBOARD ===
        let currentEmail = '';
        let filteredData = {};
        let charts = {};

        function initDashboard(email) {
            currentEmail = email;
            const user = USERS[email];
            document.getElementById('clientName').textContent = `Label: "${user.label}"`;
            document.getElementById('colName').textContent = user.label;

            filteredData = {
                projects: [...(CLIENT_DATA[email]?.projects || [])],
                heures: [...(CLIENT_DATA[email]?.heures || [])],
                ca: [...(CLIENT_DATA[email]?.ca || [])],
                coutHoraire: [...(CLIENT_DATA[email]?.coutHoraire || [])],
                duree: [...(CLIENT_DATA[email]?.duree || [])],
                regions: [...(CLIENT_DATA[email]?.regions || [])]
            };

            const regionSelect = document.getElementById('regionFilter');
            const regions = [...new Set(filteredData.regions)];
            regionSelect.innerHTML = '<option value="">Toutes</option>' + regions.map(r => `<option value="${r}">R√©gion ${r}</option>`).join('');

            updateMetrics();
            updateCharts();
            updateTable();
        }

        function calculateData() {
            const data = [];
            for (let i = 0; i < filteredData.projects.length; i++) {
                const cout = filteredData.heures[i] * filteredData.coutHoraire[i];
                const roi = filteredData.ca[i] - cout;
                const rentabilite = filteredData.ca[i] / filteredData.heures[i];
                const marge = ((roi / filteredData.ca[i]) * 100).toFixed(2);
                data.push({ cout, roi, rentabilite, marge });
            }
            return data;
        }

        function updateMetrics() {
            const data = calculateData();
            const caTotal = filteredData.ca.reduce((a, b) => a + b, 0);
            const roiTotal = data.reduce((sum, d) => sum + d.roi, 0);
            const roiMoyen = filteredData.projects.length > 0 ? (roiTotal / filteredData.projects.length).toFixed(0) : 0;
            const rentabiliteAvg = data.length > 0 ? (data.reduce((sum, d) => sum + d.rentabilite, 0) / data.length).toFixed(2) : 0;

            document.getElementById('metricsGrid').innerHTML = `
                <div class="metric-card"><div class="metric-label">CA Total</div><div class="metric-value">‚Ç¨${caTotal.toLocaleString('fr-FR')}</div></div>
                <div class="metric-card"><div class="metric-label">ROI Global</div><div class="metric-value positive">‚Ç¨${roiTotal.toLocaleString('fr-FR')}</div></div>
                <div class="metric-card"><div class="metric-label">ROI Moyen</div><div class="metric-value">‚Ç¨${roiMoyen}</div></div>
                <div class="metric-card"><div class="metric-label">Rentabilit√© Moyenne</div><div class="metric-value">‚Ç¨${rentabiliteAvg}/h</div></div>
            `;
        }

        function updateCharts() {
            if (filteredData.projects.length === 0) return;
            const colors = ['#2180A0', '#32B8C6', '#A84F2F', '#FF5459'];
            const data = calculateData();

            const caCtx = document.getElementById('caChart').getContext('2d');
            if (charts.ca) charts.ca.destroy();
            charts.ca = new Chart(caCtx, {
                type: 'bar',
                data: {
                    labels: filteredData.projects,
                    datasets: [{
                        label: 'CA (‚Ç¨)',
                        data: filteredData.ca,
                        backgroundColor: colors.slice(0, filteredData.projects.length),
                        borderRadius: 6
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            const roiCtx = document.getElementById('roiChart').getContext('2d');
            if (charts.roi) charts.roi.destroy();
            charts.roi = new Chart(roiCtx, {
                type: 'bar',
                data: {
                    labels: filteredData.projects,
                    datasets: [{
                        label: 'ROI (‚Ç¨)',
                        data: data.map(d => d.roi),
                        backgroundColor: colors.slice(0, filteredData.projects.length),
                        borderRadius: 6
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            const regionData = {};
            filteredData.projects.forEach((p, i) => {
                regionData[filteredData.regions[i]] = (regionData[filteredData.regions[i]] || 0) + filteredData.ca[i];
            });

            const regionCtx = document.getElementById('regionChart').getContext('2d');
            if (charts.region) charts.region.destroy();
            charts.region = new Chart(regionCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(regionData),
                    datasets: [{
                        data: Object.values(regionData),
                        backgroundColor: ['#2180A0', '#32B8C6', '#A84F2F']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            const rentCtx = document.getElementById('rentabiliteChart').getContext('2d');
            if (charts.rent) charts.rent.destroy();
            charts.rent = new Chart(rentCtx, {
                type: 'line',
                data: {
                    labels: filteredData.projects,
                    datasets: [{
                        label: 'Rentabilit√©/h (‚Ç¨)',
                        data: data.map(d => d.rentabilite),
                        borderColor: '#2180A0',
                        backgroundColor: 'rgba(33, 128, 141, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: true } } }
            });
        }

        function updateTable() {
            const data = calculateData();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filteredData.projects.map((project, i) => `
                <tr>
                    <td><strong>${project}</strong></td>
                    <td>${filteredData.heures[i]}</td>
                    <td>‚Ç¨${filteredData.ca[i].toLocaleString('fr-FR')}</td>
                    <td>‚Ç¨${data[i].cout.toLocaleString('fr-FR')}</td>
                    <td class="positive">‚Ç¨${data[i].roi.toLocaleString('fr-FR')}</td>
                    <td>‚Ç¨${data[i].rentabilite.toFixed(2)}/h</td>
                    <td>${data[i].marge}%</td>
                    <td>R√©gion ${filteredData.regions[i]}</td>
                </tr>
            `).join('');
        }

        function applyFilters() {
            const region = document.getElementById('regionFilter').value;
            const rentMin = parseFloat(document.getElementById('rentabiliteFilter').value) || 0;

            const original = CLIENT_DATA[currentEmail];
            filteredData = { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] };

            for (let i = 0; i < original.projects.length; i++) {
                const rentabilite = original.ca[i] / original.heures[i];
                if ((!region || original.regions[i] === region) && rentabilite >= rentMin) {
                    filteredData.projects.push(original.projects[i]);
                    filteredData.heures.push(original.heures[i]);
                    filteredData.ca.push(original.ca[i]);
                    filteredData.coutHoraire.push(original.coutHoraire[i]);
                    filteredData.duree.push(original.duree[i]);
                    filteredData.regions.push(original.regions[i]);
                }
            }

            updateMetrics();
            updateCharts();
            updateTable();
        }

        function resetFilters() {
            document.getElementById('regionFilter').value = '';
            document.getElementById('rentabiliteFilter').value = '';
            filteredData = {
                projects: [...CLIENT_DATA[currentEmail].projects],
                heures: [...CLIENT_DATA[currentEmail].heures],
                ca: [...CLIENT_DATA[currentEmail].ca],
                coutHoraire: [...CLIENT_DATA[currentEmail].coutHoraire],
                duree: [...CLIENT_DATA[currentEmail].duree],
                regions: [...CLIENT_DATA[currentEmail].regions]
            };
            updateMetrics();
            updateCharts();
            updateTable();
        }

        function downloadMyTemplate() {
            const user = USERS[currentEmail];
            const label = user.label;
            let csv = `${label},Nb Heures,CA G√©n√©r√©,Co√ªt Horaire,Dur√©e Mois,R√©gion\n`;
            csv += `${label} 1,,,,,\n`;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'modele.csv';
            link.click();
        }

        function uploadCSV() {
            const file = document.getElementById('csvFile').files[0];
            const errorMsg = document.getElementById('errorUpload');
            const successMsg = document.getElementById('successUpload');

            if (!file) { errorMsg.textContent = '‚ùå S√©lectionne un fichier'; errorMsg.classList.add('show'); return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const newData = { projects: [], heures: [], ca: [], coutHoraire: [], duree: [], regions: [] };

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',').map(v => v.trim());
                        newData.projects.push(values[0]);
                        newData.heures.push(parseInt(values[1]));
                        newData.ca.push(parseInt(values[2]));
                        newData.coutHoraire.push(parseInt(values[3]));
                        newData.duree.push(parseInt(values[4]));
                        newData.regions.push(values[5]);
                    }

                    if (newData.projects.length > 0) {
                        CLIENT_DATA[currentEmail] = newData;
                        saveData();
                        filteredData = { ...newData };
                        successMsg.textContent = `‚úÖ ${newData.projects.length} ligne(s)`;
                        successMsg.classList.add('show');
                        errorMsg.classList.remove('show');
                        setTimeout(() => successMsg.classList.remove('show'), 3000);
                        document.getElementById('csvFile').value = '';
                        updateMetrics();
                        updateCharts();
                        updateTable();
                    }
                } catch (error) {
                    errorMsg.textContent = '‚ùå Erreur CSV';
                    errorMsg.classList.add('show');
                }
            };
            reader.readAsText(file);
        }

        function exportToCSV() {
            const user = USERS[currentEmail];
            const data = calculateData();
            let csv = `${user.label},Heures,CA,Co√ªt,ROI,Rentabilit√©/h,Marge %,R√©gion\n`;
            for (let i = 0; i < filteredData.projects.length; i++) {
                csv += `${filteredData.projects[i]},${filteredData.heures[i]},${filteredData.ca[i]},${data[i].cout},${data[i].roi},${data[i].rentabilite.toFixed(2)},${data[i].marge},${filteredData.regions[i]}\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function exportToJSON() {
            const data = calculateData();
            const json = {
                date: new Date().toISOString(),
                user: currentEmail,
                data: filteredData.projects.map((p, i) => ({
                    [USERS[currentEmail].label]: p,
                    heures: filteredData.heures[i],
                    ca: filteredData.ca[i],
                    cout: data[i].cout,
                    roi: data[i].roi,
                    rentabilite: data[i].rentabilite,
                    marge: data[i].marge,
                    region: filteredData.regions[i]
                }))
            };
            const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
    </script>
</body>
</html>
